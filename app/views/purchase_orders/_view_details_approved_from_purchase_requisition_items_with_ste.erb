<% if action_name == "printable" %>
  <table id="grid_h360" class="black-line-table" width="100%">
<% else %>
  <table id="grid_h360" class="white-line-table" width="100%">
<% end %>
    
    <thead>
      <tr class="header_line">
          <th style="font-size: 12px;">NO.</th>
          <% unless action_name == "printable" %>
            <th style="font-size: 12px;">RN Status</th>
            <th style="font-size: 12px;">PR No.</th>
          <% end %>
          <th style="font-size: 12px;">PRODUCT ID</th>
          <th style="font-size: 12px;">DESCRIPTION</th>
          <th style="font-size: 12px;">ETA</th>
          <th style="font-size: 12px;">QUANTITY</th>
          <th style="font-size: 12px;">U/M</th>
          <th style="font-size: 12px;">UNIT PRICE</th>
          <th style="font-size: 12px;">AMOUNT</th>
          <% if action_name == "new" %>
            <th style="font-size: 12px;">TARIF CODE</th>
            <th style="font-size: 12px;">TOTAL</th>
            <th style="font-size: 12px;">COMPLETE QTY</th>
          <% end %>
      </tr>
    </thead>
    
    <tbody>
      <% subtotal = [] %>

      <% approved.each_with_index do |k, index| %>
        <tr class="<%= cycle("odd_line", "even_line") %>">
          <td align="center"><%= index + 1 %></td>
          <% unless action_name == "printable" %>
            <td align="center">
              <% if k.status == PurchaseRequisitionItem::RECEIVED_PARTIAL %>
                <%= link_to "Received Partial", purchase_order_item_line_path(k.purchase_order_item_line), :class => "show_without_refresh_page_1600x900", "data-fancybox-type" => "iframe" %>
              <% elsif k.status == PurchaseRequisitionItem::RECEIVED_FULL %>
                <%= link_to "Received Full", purchase_order_item_line_path(k.purchase_order_item_line), :class => "show_without_refresh_page_1600x900", "data-fancybox-type" => "iframe" %>
              <% else %>
                <span title="Not Received Yet">N.R</span>
              <% end %>
            </td>
            <td align="center">
              <%= link_to(k.purchase_requisition.pr_no, purchase_requisition_path(k.purchase_requisition_id), :class => "show_without_refresh_page_1600x900", "data-fancybox-type" => "iframe" ) %>
            </td>
          <% end %>
          <td align="center">
            <% if k.product.blank? %>
              <%= link_to "Add Product", message_products_path(:pri_id => k.id, :po_desc => k.description, :po_um_id => k.unit_measurement_id, :po_up => k.unit_price, :po_vendor_id => k.trade_company_id), :class => "add_product" %>
            <% else %>
              <% unless action_name == "printable" %>
                <%= link_to(product_path(k.product_id), { :class => "show_without_refresh_page_800x450", "data-fancybox-type" => "iframe"}) do %>
                  <%= render "/product_categories/join_product_category", :pc => k %>
                <% end %>
              <% else %>
                <%= render "/product_categories/join_product_category", :pc => k %>
              <% end %>
            <% end %>
          </td>
          <td><%= simple_format(k.description) %></td>
          <td align="center">
            <% if k.eta < Date.today %>
              <span class="red_alert"><%= k.eta.strftime("%d-%m-%Y") rescue '-' %></span>
            <% else %>
              <%= k.eta.strftime("%d-%m-%Y") rescue '-' %>
            <% end %>
          </td>
          <td align="center"><%= k.quantity rescue '0' %></td>
          <td align="center"><%= k.unit_measurement.code rescue '-' %></td>
          <td align="right"><%= four_precision(k.unit_price) %></td>
          <td align="right">
            <%= iproduct(k.quantity, k.unit_price) %>
            <% subtotal << k.quantity * k.unit_price %>
          </td>

          <% if action_name == "new" %>
          
            <% if @vendor_id.sales_tax_exemption.present? %>
          
              <% if k.product_id.present? %>
                <%# if k.product.sales_tax_exemption_barang_id.present? %>
                <% if k.product.tarif_code.present? %>
          
                  <%# @find_vendor = ste_no_with_valid.find_by_id_and_trade_company_id(k.product.sales_tax_exemption_id, k.trade_company_id) %>
                  <%# if @find_vendor.present? %>
                    <td align="center"><%= k.product.tarif_code rescue '-' %></td>
                    <td align="center">
                      <% if params[:kgs].present? %>
                        <%= text_field_tag "kgs[#{k.id.to_s}][qty]", params[:kgs]["#{k.id.to_s}"][:qty], :size => 5  %>
                      <% else %>
                        <%= text_field_tag "kgs[#{k.id.to_s}][qty]", 0, :size => 5  %>
                      <% end %>
                    </td>
                    <td align="center">
                      <%#= find_completed_qty(@vendor_id.id, k.product.tarif_code) %>
                      <% if @vendor_id.sales_tax_exemption.sales_tax_exemption_barangs.present? %>
                        <% available = @vendor_id.sales_tax_exemption.sales_tax_exemption_barangs.find_by_tarif_code(k.product.tarif_code) %>
                        <%= available.complete_qty  %>
                      <% end %>
                    </td>
                  <%# end %>
                    
                <% else %>
                  <td><i class="red_alert">Please Entry Tarif Code from Product ID.</i></td>
                <% end %>
              <% end %>
            <% end %>
                  
          <% end %>
        </tr>
      <% end %>      

      <% gt = cal_grandtotal(subtotal.sum(), @purchase_order.tax.to_f) %>

      <tr class="footer_line">
        <% unless action_name == "printable" %>
          <td align="right" colspan="9">Sub-Total</td>
        <% else %>
          <td align="right" colspan="7">Sub-Total</td>
        <% end %>
        <td align="right" title="<%= number_with_precision(subtotal.sum(), :precision => 2) %>" class="po_subtotal"><%= number_with_precision(subtotal.sum(), :precision => 2, :separator => '.', :delimiter => ',') %></td>
      </tr>
      <tr class="footer_line">
        <% unless action_name == "printable" %>
          <td align="right" colspan="9">Add S/Tax <span id="po_percent"><%= @purchase_order.tax rescue '0' %></span>%</td>
        <% else %>
          <td align="right" colspan="7">Add S/Tax <span id="po_percent"><%= @purchase_order.tax rescue '0' %></span>%</td>
        <% end %>
        <td align="right" class="add_s_tax"><%= number_with_precision(@purchase_order.tax.to_f / 100, :precision => 2, :separator => '.', :delimiter => ',') %></td>
      </tr>
      <tr class="footer_line">
        <% unless action_name == "printable" %>
          <td align="right" colspan="9">Grand Total</td>
        <% else %>
          <td align="right" colspan="7">Grand Total</td>
        <% end %>
        <td align="right" class="po_grandtotal"><%= number_with_precision(gt, :precision => 2, :separator => '.', :delimiter => ',') %></td>
      </tr>
    </tbody>
</table>